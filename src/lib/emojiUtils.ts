// src/lib/emojiUtils.ts
import { Item } from '../types/api';

// 1. ì´ëª¨ì§€ ë§¤í•‘ í•¨ìˆ˜
export const getFoodEmoji = (itemName: string): string => {
  const emojiMap: Record<string, string> = {
    // ê³¼ì¼ë¥˜
    'í¬ë„': 'ğŸ‡',
    'ë©œë¡ ': 'ğŸˆ',
    'ìˆ˜ë°•': 'ğŸ‰',
    'ê·¤': 'ğŸŠ',
    'ì˜¤ë Œì§€': 'ğŸŠ',
    'ë ˆëª¬': 'ğŸ‹',
    'ë°”ë‚˜ë‚˜': 'ğŸŒ',
    'íŒŒì¸ì• í”Œ': 'ğŸ',
    'ë§ê³ ': 'ğŸ¥­',
    'ì‚¬ê³¼': 'ğŸ',
    'ì´ˆë¡ ì‚¬ê³¼': 'ğŸ',
    'ë°°': 'ğŸ',
    'ë³µìˆ­ì•„': 'ğŸ‘',
    'ì²´ë¦¬': 'ğŸ’',
    'ë”¸ê¸°': 'ğŸ“',
    'ë¸”ë£¨ë² ë¦¬': 'ğŸ«',
    'í‚¤ìœ„': 'ğŸ¥',
    'ì½”ì½”ë„›': 'ğŸ¥¥',
    'ì˜¬ë¦¬ë¸Œ': 'ğŸ«’',
    // ì±„ì†ŒÂ·ê²¬ê³¼ë¥˜
    'í† ë§ˆí† ': 'ğŸ…',
    'ê°€ì§€': 'ğŸ†',
    'ì•„ë³´ì¹´ë„': 'ğŸ¥‘',
    'ë¸Œë¡œì½œë¦¬': 'ğŸ¥¦',
    'ê³ ì¶”': 'ğŸŒ¶ï¸',
    'ì˜¤ì´ê³ ì¶”': 'ğŸŒ¶ï¸',
    'í”¼ë§': 'ğŸ«‘',
    'ì˜¥ìˆ˜ìˆ˜': 'ğŸŒ½',
    'ë‹¹ê·¼': 'ğŸ¥•',
    'ê°ì': 'ğŸ¥”',
    'ì˜¤ì´': 'ğŸ¥’',
    'ìì±„ì†Œ': 'ğŸ¥¬',
    'ë°°ì¶”': 'ğŸ¥¬',
    'ë²„ì„¯': 'ğŸ„',
    'ë§ˆëŠ˜': 'ğŸ§„',
    'ì–‘íŒŒ': 'ğŸ§…',
    'ë°¤': 'ğŸŒ°',
    'ë•…ì½©': 'ğŸ¥œ',
    'ì½©': 'ğŸ«˜',
    'ê³ êµ¬ë§ˆ': 'ğŸ ',
    // ê³¡ë¬¼Â·ë°¥ë¥˜
    'ë°¥': 'ğŸš',
    'ìŒ€': 'ğŸš',
    'ì£¼ë¨¹ë°¥': 'ğŸ™',
    'ìŒ€ê³¼ì': 'ğŸ˜',
    'ì¹´ë ˆ': 'ğŸ›',
    // êµ­Â·ìˆ˜í”„Â·ë©´ë¥˜
    'ë¼ë©˜': 'ğŸœ',
    'ë¼ë©´': 'ğŸœ',
    'íŒŒìŠ¤íƒ€': 'ğŸ',
    'ìŠ¤íŠœ': 'ğŸ²',
    'ìˆ˜í”„': 'ğŸ¥£',
    'ìŠ¤í”„': 'ğŸ¥£',
    'íŒŒì—ì•¼': 'ğŸ¥˜',
    // ë¹µÂ·ë² ì´ì»¤ë¦¬Â·íŒ¨ìŠ¤íŠ¸í‘¸ë“œ
    'ë¹µ': 'ğŸ',
    'í¬ë£¨ì•„ìƒ': 'ğŸ¥',
    'ë°”ê²ŒíŠ¸': 'ğŸ¥–',
    'í”„ë ˆì²¼': 'ğŸ¥¨',
    'ë² ì´ê¸€': 'ğŸ¥¯',
    'íŒ¬ì¼€ì´í¬': 'ğŸ¥',
    'ì™€í”Œ': 'ğŸ§‡',
    'í–„ë²„ê±°': 'ğŸ”',
    'ê°ìíŠ€ê¹€': 'ğŸŸ',
    'í”¼ì': 'ğŸ•',
    'í•«ë„ê·¸': 'ğŸŒ­',
    'ìƒŒë“œìœ„ì¹˜': 'ğŸ¥ª',
    'íƒ€ì½”': 'ğŸŒ®',
    'ë¶€ë¦¬í† ': 'ğŸŒ¯',
    'íƒ€ë§ë ˆ': 'ğŸ«”',
    'íŒ”ë¼í ': 'ğŸ§†',
    // ê³ ê¸°Â·ê³„ë€ë¥˜
    'ë¼ˆ': 'ğŸ¦´',
    'ë‹­': 'ğŸ—',
    'ë‹­ê³ ê¸°': 'ğŸ—',
    'ë‹­ë‹¤ë¦¬': 'ğŸ—',
    'ì†Œê³ ê¸°': 'ğŸ¥©',
    'ë¹„í”„': 'ğŸ¥©',
    'ìŠ¤í…Œì´í¬': 'ğŸ¥©',
    'ë¼ì§€': 'ğŸ¥“',
    'ë¼ì§€ê³ ê¸°': 'ğŸ¥“',
    'í¬í¬': 'ğŸ¥“',
    'ë² ì´ì»¨': 'ğŸ¥“',
    'ì‚¼ê²¹ì‚´': 'ğŸ¥“',
    'ê³„ë€': 'ğŸ¥š',
    'ë‹¬ê±€': 'ğŸ¥š',
    'ì—ê·¸': 'ğŸ¥š',
    // í•´ì‚°ë¬¼ë¥˜
    'ì´ˆë°¥': 'ğŸ£',
    'ë„ì‹œë½': 'ğŸ±',
    'íŠ€ê¸´ ìƒˆìš°': 'ğŸ¤',
    'êµ´': 'ğŸ¦ª',
    'ë°”ë‹·ê°€ì¬': 'ğŸ¦',
    'ê½ƒê²Œ': 'ğŸ¦€',
    'ìƒˆìš°': 'ğŸ¦',
    'ì˜¤ì§•ì–´': 'ğŸ¦‘',
    'ë¬¼ê³ ê¸°': 'ğŸŸ',
    'ìƒì„ ': 'ğŸŸ',
    'ê³ ë“±ì–´': 'ğŸŸ',
    'ê°ˆì¹˜': 'ğŸŸ',
    'ì—´ëŒ€ì–´': 'ğŸ ',
    'ë³µì–´': 'ğŸ¡',
    'ìƒì–´': 'ğŸ¦ˆ',
    'ì–´ë¬µ': 'ğŸ¥',
    'ì˜¤ë…': 'ğŸ¢',
    // ê°„ì‹Â·ë””ì €íŠ¸ë¥˜
    'íŒì½˜': 'ğŸ¿',
    'ì¿ í‚¤': 'ğŸª',
    'ë„ë„›': 'ğŸ©',
    'ì»µì¼€ì´í¬': 'ğŸ§',
    'ìƒì¼ì¼€ì´í¬': 'ğŸ‚',
    'ì¼€ì´í¬': 'ğŸ°',
    'íŒŒì´': 'ğŸ¥§',
    'ì•„ì´ìŠ¤í¬ë¦¼': 'ğŸ¦',
    'ë¹™ìˆ˜': 'ğŸ§',
    'ë¡¤ë¦¬íŒ': 'ğŸ­',
    'ì‚¬íƒ•': 'ğŸ¬',
    'ì´ˆì½œë¦¿': 'ğŸ«',
    'í‘¸ë”©': 'ğŸ®',
    'ê¿€': 'ğŸ¯',
    // ìœ ì œí’ˆÂ·ì–‘ë…ë¥˜
    'ì¹˜ì¦ˆ': 'ğŸ§€',
    'ë²„í„°': 'ğŸ§ˆ',
    'ìš°ìœ ': 'ğŸ¥›',
    'ì –ë³‘': 'ğŸ¼',
    'ì†Œê¸ˆ': 'ğŸ§‚',
    'ì„¤íƒ•': 'ğŸ§‚',
    // ìŒë£Œë¥˜
    'ì»¤í”¼': 'â˜•',
    'ì°¨': 'ğŸµ',
    'ìŒë£Œì»µ(ìŠ¤íŠ¸ë¡œìš°)': 'ğŸ¥¤',
    'ì£¼ìŠ¤': 'ğŸ§ƒ',
    'ë²„ë¸”í‹°': 'ğŸ§‹',
    'ì‚¬ì¼€': 'ğŸ¶',
    'ìƒ´í˜ì¸': 'ğŸ¾',
    'ì™€ì¸': 'ğŸ·',
    'ì¹µí…Œì¼': 'ğŸ¸',
    'ë§¥ì£¼': 'ğŸº',
    'ìœ„ìŠ¤í‚¤': 'ğŸ¥ƒ',
    'ì–¼ìŒ': 'ğŸ§Š',
    'ìƒìˆ˜': 'ğŸ’§',
    // íŠ¹ìˆ˜Â·ì„¸ê³„ ìŒì‹ë¥˜
    'ë§Œë‘': 'ğŸ¥Ÿ',
    'í¬ì¶˜ ì¿ í‚¤': 'ğŸ¥ ',
    'ë‹¹ê³ ': 'ğŸ¡',
    'ì›”ë³‘': 'ğŸ¥®',
    'í…Œì´í¬ì•„ì›ƒ ë°•ìŠ¤': 'ğŸ¥¡',
    'ìƒëŸ¬ë“œ': 'ğŸ¥—',
    'ì£½': 'ğŸ¥£',
  };

  for (const [key, emoji] of Object.entries(emojiMap)) {
    const regex = new RegExp(key, "i");
    if (regex.test(itemName)) {
      return emoji;
    }
  }

  return 'ğŸ½ï¸';
};

// 2. LLM í˜¸ì¶œ ë° ìºì‹± í•¨ìˆ˜
const EMOJI_CATEGORY_CACHE_KEY = 'emojiCategoryCache';

const getCachedCategory = (itemName: string): string | null => {
  if (typeof window === 'undefined') return null;
  const cache = JSON.parse(localStorage.getItem(EMOJI_CATEGORY_CACHE_KEY) || '{}');
  return cache[itemName] || null;
};

const setCachedCategory = (itemName: string, category: string) => {
  if (typeof window === 'undefined') return;
  const cache = JSON.parse(localStorage.getItem(EMOJI_CATEGORY_CACHE_KEY) || '{}');
  cache[itemName] = category;
  localStorage.setItem(EMOJI_CATEGORY_CACHE_KEY, JSON.stringify(cache));
};

export const extractMainCategory = async (itemName: string): Promise<string> => {
  // 1. ìºì‹œ ì²´í¬
  const cached = getCachedCategory(itemName);
  if (cached) return cached;

  // 2. í”„ë¡¬í”„íŠ¸ ì‘ì„±
  const prompt = `
ë‹¤ìŒ ì…ë ¥ê°’ì—ì„œ ìŒì‹/ì‹í’ˆì˜ ì£¼ì¢…ë¥˜ë¥¼ í•œ ë‹¨ì–´ë¡œ ì¶”ì¶œí•´ì¤˜. ì˜ˆì‹œ:
ì…ë ¥: "ë°”ë‚˜ë‚˜ë§› ìš°ìœ " â†’ ì¶œë ¥: "ìš°ìœ "
ì…ë ¥: "ì´ˆì½”ì¹© ì¿ í‚¤" â†’ ì¶œë ¥: "ì¿ í‚¤"
ì…ë ¥: "ë”¸ê¸°ë§› ìš”êµ¬ë¥´íŠ¸" â†’ ì¶œë ¥: "ìš”êµ¬ë¥´íŠ¸"
ì…ë ¥: "${itemName}" â†’ ì¶œë ¥:
  `.trim();

  // 3. LLM API í˜¸ì¶œ (OpenAI ì˜ˆì‹œ)
  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${process.env.NEXT_PUBLIC_OPENAI_API_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [{ role: 'user', content: prompt }],
        max_tokens: 10,
        temperature: 0
      })
    });

    const data = await response.json();
    const category = data.choices?.[0]?.message?.content?.trim().replace(/["']/g, '') || itemName;

    // 4. ìºì‹œì— ì €ì¥
    setCachedCategory(itemName, category);

    return category;
  } catch (error) {
    console.error('LLM í˜¸ì¶œ ì‹¤íŒ¨:', error);
    return itemName; // ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
  }
};
